name: Sync Worker Secrets

on:
  workflow_dispatch:
    inputs:
      workers:
        description: 'Workers to sync secrets to (comma-separated, or "all")'
        default: 'all'
        required: false

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler@latest

      - name: Sync secrets to all workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GITHUB_TOKEN_SECRET: ${{ secrets.GH_TOKEN }}
          RAILWAY_TOKEN_SECRET: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          TARGET_WORKERS="${{ inputs.workers }}"
          
          for worker in domains/*/; do
            name=$(basename "$worker")
            
            # If specific workers requested, skip others
            if [ "$TARGET_WORKERS" != "all" ]; then
              if ! echo ",$TARGET_WORKERS," | grep -q ",$name,"; then
                echo "‚è≠ Skipping: $name"
                continue
              fi
            fi
            
            if [ ! -f "$worker/wrangler.toml" ]; then
              echo "‚ö† No wrangler.toml in $name ‚Äî skipping"
              continue
            fi
            
            WORKER_NAME=$(grep '^name' "$worker/wrangler.toml" | head -1 | cut -d'"' -f2)
            if [ -z "$WORKER_NAME" ]; then
              echo "‚ö† Could not determine worker name from $worker/wrangler.toml ‚Äî skipping"
              continue
            fi
            
            echo "üîë Syncing secrets to: $WORKER_NAME"
            cd "$worker"
            
            if [ -n "$GITHUB_TOKEN_SECRET" ]; then
              echo "$GITHUB_TOKEN_SECRET" | npx wrangler secret put GITHUB_TOKEN --name "$WORKER_NAME" 2>/dev/null \
                && echo "  ‚úÖ GITHUB_TOKEN" || echo "  ‚ùå GITHUB_TOKEN failed"
            fi
            
            if [ -n "$RAILWAY_TOKEN_SECRET" ]; then
              echo "$RAILWAY_TOKEN_SECRET" | npx wrangler secret put RAILWAY_TOKEN --name "$WORKER_NAME" 2>/dev/null \
                && echo "  ‚úÖ RAILWAY_TOKEN" || echo "  ‚ùå RAILWAY_TOKEN failed"
            fi
            
            cd ../..
          done
          
          echo ""
          echo "‚úÖ Secret sync complete"
